# AiTril v0.0.33 Test Dockerfile
# Tests specialized code/agent providers in clean environment

FROM ubuntu:24.04

# Prevent interactive prompts
ENV DEBIAN_FRONTEND=noninteractive

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    software-properties-common \
    build-essential \
    curl \
    git \
    ca-certificates \
    libffi-dev \
    libssl-dev \
    && add-apt-repository ppa:deadsnakes/ppa -y \
    && apt-get update \
    && apt-get install -y --no-install-recommends \
    python3.14 \
    python3.14-dev \
    python3.14-venv \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*

# Set Python 3.14 as default
RUN update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.14 1 \
    && update-alternatives --install /usr/bin/python python /usr/bin/python3.14 1

# Upgrade pip
RUN python3 -m pip install --upgrade pip setuptools wheel --break-system-packages

# Install cffi explicitly
RUN pip install cffi --break-system-packages

# Copy source code (for development testing)
COPY . /app

# Install AiTril in development mode
RUN pip install -e . --break-system-packages

# Install web extras
RUN pip install -e .[web] --break-system-packages

# Install Claude Code CLI (if available)
# For now, we'll test with fallback to AnthropicProvider
# TODO: Add actual Claude Code CLI installation when available

# Environment variables for testing
ENV USE_SPECIALIZED_PROVIDERS=true
ENV CLAUDE_CODE_CLI_PATH=/usr/local/bin/claude
ENV OPENAI_CODEX_MODEL=gpt-4-turbo
ENV GEMINI_ADK_MODEL=gemini-2.0-flash-exp

# Reset environment
ENV DEBIAN_FRONTEND=

# Expose web server port
EXPOSE 37142

# Default command: run tests
CMD ["python3", "-m", "pytest", "-v"]

# Usage:
# Build: docker build -f Dockerfile.test -t aitril-test:0.0.33 .
# Test: docker run --env-file .env aitril-test:0.0.33
# Shell: docker run -it --env-file .env aitril-test:0.0.33 bash
